# CI workflow for testing the AWS Quick Assess action itself
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - name: Run unit tests
        run: pytest tests/ -v --cov=src --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black mypy

      - name: Run Black (format check)
        run: black src/ --check --diff

      - name: Run Flake8
        # E203 is intentionally ignored as it conflicts with Black's slice formatting
        run: flake8 src/ --max-line-length=120 --extend-ignore=E203

      - name: Run Pylint
        run: pylint src/ --disable=C0301,R0913,R0914 || true

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: aws-quick-assess:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  integration-test:
    name: Integration Test
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t aws-quick-assess:test .

      - name: Create output directory
        run: mkdir -p test-reports && chmod 777 test-reports

      - name: Run integration test with test fixtures
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests/fixtures:/repo:ro \
            -v ${{ github.workspace }}/test-reports:/app/reports \
            aws-quick-assess:test \
            scan-local --repo-path /repo --output-dir /app/reports --format json || true

      - name: Verify report generated
        run: |
          echo "Contents of test-reports directory:"
          ls -la test-reports/
          echo ""
          echo "Looking for JSON report..."
          if ls test-reports/*.json 1> /dev/null 2>&1; then
            echo "JSON report found!"
            echo "Report preview:"
            head -50 test-reports/*.json
          else
            echo "ERROR: No JSON report generated"
            exit 1
          fi

  action-test:
    name: Test Action
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test action on fixtures
        uses: ./
        id: scan
        with:
          scan-path: 'tests/fixtures'
          output-formats: 'json'
          fail-on-severity: 'NONE'  # Don't fail on test fixtures
          verbose: 'true'

      - name: Verify outputs
        run: |
          echo "Findings count: ${{ steps.scan.outputs.findings-count }}"
          echo "Critical count: ${{ steps.scan.outputs.critical-count }}"
          echo "High count: ${{ steps.scan.outputs.high-count }}"
          echo "Scan status: ${{ steps.scan.outputs.scan-status }}"
          echo "Report path: ${{ steps.scan.outputs.report-path }}"

  release:
    name: Release
    needs: [test, lint, build, integration-test, action-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
